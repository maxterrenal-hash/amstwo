<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ospital ng Makati – Antimicrobial Request System (Pharmacy)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --osmak-green: #009a3e;
      --osmak-green-dark: #007530;
      --osmak-red: #dc2626;
      --amber: #f59e0b;
      --amber-dark: #b45309;
      --bg-main: #f5f5f5;
      --bg-card: #ffffff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border: #d1d5db;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
    }

    header {
      background: var(--osmak-green);
      padding: 1rem;
      color: white;
      font-size: 1.4rem;
      font-weight: bold;
      text-align: center;
    }

    .tabs {
      display: flex;
      justify-content: center;
      background: white;
      border-bottom: 1px solid var(--border);
    }

    .tabs button {
      flex: 1;
      padding: 0.9rem;
      border: none;
      background: white;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 500;
      border-right: 1px solid var(--border);
    }

    .tabs button.active {
      background: var(--osmak-green);
      color: white;
    }

    .tab-content { padding: 1rem; }

    .card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .tag {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      margin-right: 0.3rem;
      border-radius: 6px;
      font-size: 0.75rem;
      color: white;
    }

    .tag.restricted { background: var(--osmak-red); }
    .tag.monitored { background: var(--osmak-green-dark); }
    .tag.pending { background: var(--amber); color: black; }
    .tag.approved { background: var(--osmak-green); }
    .tag.disapproved { background: var(--osmak-red); }
    .tag.ids { background: #2563eb; }

    .btn {
      padding: 0.45rem 0.7rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 0.4rem;
      font-size: 0.85rem;
      width: 120px;
    }

    .btn-approve { background: var(--osmak-green); color: white; }
    .btn-reject { background: var(--osmak-red); color: white; }
    .btn-ids { background: #2563eb; color: white; }
    .btn-delete { background: #6b7280; color: white; }

    #modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.45);
      display: none;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    #modal-content {
      background: white;
      width: 100%;
      max-width: 600px;
      border-radius: 10px;
      padding: 1.2rem;
    }

  </style>
</head>

<body>
<header>AMS Request System – Pharmacy Module</header>

<div class="tabs">
  <button id="tab-pending" class="active">Pending</button>
  <button id="tab-approved">Approved</button>
  <button id="tab-rejected">Rejected</button>
  <button id="tab-ids">IDS Approval</button>
  <button id="tab-analysis">Data Analysis</button>
</div>

<div id="pending" class="tab-content"></div>
<div id="approved" class="tab-content" style="display:none"></div>
<div id="rejected" class="tab-content" style="display:none"></div>
<div id="ids" class="tab-content" style="display:none"></div>
<div id="analysis" class="tab-content" style="display:none"></div>

<!-- Modal -->
<div id="modal">
  <div id="modal-content"></div>
</div>

<script>
/* ============================================================
   CONFIG
============================================================ */
const API_URL = "YOUR_DEPLOYED_WEBAPP_URL";  // PATCH THIS with actual URL

let ALL_DATA = [];

/* ============================================================
   FETCH DATA
============================================================ */
async function loadData() {
  const res = await fetch(API_URL);
  const json = await res.json();
  ALL_DATA = json.entries.map(e => ({
    fileId: e.fileId,
    ...e.data   // all normalized keys
  }));
}

/* ============================================================
   TAB SWITCHER
============================================================ */
function showTab(id) {
  document.querySelectorAll(".tab-content").forEach(el => el.style.display = "none");
  document.getElementById(id).style.display = "block";

  document.querySelectorAll(".tabs button").forEach(el => el.classList.remove("active"));
  document.getElementById("tab-" + id).classList.add("active");
}

/* ============================================================
   RENDERERS
============================================================ */
function renderPending() {
  const wrap = document.getElementById("pending");
  wrap.innerHTML = "";

  const items = ALL_DATA.filter(d => d.status === "pending");

  if (items.length === 0) {
    wrap.innerHTML = `<p>No pending requests.</p>`;
    return;
  }

  items.forEach(d => {
    wrap.appendChild(renderCard(d, "pending"));
  });
}

function renderApproved() {
  const wrap = document.getElementById("approved");
  wrap.innerHTML = "";

  const items = ALL_DATA.filter(d => d.status === "approved");

  if (items.length === 0) {
    wrap.innerHTML = `<p>No approved entries.</p>`;
    return;
  }

  items.forEach(d => {
    wrap.appendChild(renderCard(d, "approved"));
  });
}

function renderRejected() {
  const wrap = document.getElementById("rejected");
  wrap.innerHTML = "";

  const items = ALL_DATA.filter(d => d.status === "disapproved");

  if (items.length === 0) {
    wrap.innerHTML = `<p>No rejected entries.</p>`;
    return;
  }

  items.forEach(d => {
    wrap.appendChild(renderCard(d, "disapproved"));
  });
}

function renderIDS() {
  const wrap = document.getElementById("ids");
  wrap.innerHTML = "";

  const items = ALL_DATA.filter(d => d.status === "for_ids_approval");

  if (items.length === 0) {
    wrap.innerHTML = `<p>No IDS approvals.</p>`;
    return;
  }

  items.forEach(d => {
    wrap.appendChild(renderCard(d, "for_ids_approval"));
  });
}
<script>

/* ============================================================
   CARD RENDERER
============================================================ */
function renderCard(d, section) {
  const card = document.createElement("div");
  card.className = "card";

  const tag =
    d.drugtype === "Restricted" ? "restricted" :
    d.drugtype === "Monitored" ? "monitored" : "pending";

  card.innerHTML = `
    <div style="display:flex; justify-content:space-between;">
      <div>
        <strong>${d.patientName}</strong><br>
        <small>${d.hospitalnumber}</small>
      </div>
      <div>
        <span class="tag ${tag}">${d.drugtype}</span>
        <span class="tag ${d.status}">${d.status}</span>
      </div>
    </div>

    <div style="margin-top:0.6rem;">
      <strong>${d.antimicrobial}</strong><br>
      ${d.dose} — ${d.frequency}
    </div>

    <div style="margin-top:0.6rem;">
      <small>${d.ward} • ${d.date}</small>
    </div>

    <div style="margin-top:0.7rem;">
      ${renderButtons(d, section)}
    </div>
  `;

  card.querySelectorAll("button").forEach(btn => {
    btn.onclick = (ev) => {
      ev.stopPropagation();
      handleButtonClick(btn.dataset.action, d);
    };
  });

  card.onclick = () => openModal(d);

  return card;
}

/* ============================================================
   BUTTON SET
============================================================ */
function renderButtons(d, section) {
  if (section === "pending") {
    return `
      ${d.drugtype === "Restricted"
        ? `<button class="btn btn-ids" data-action="ids">For IDS</button>`
        : `<button class="btn btn-approve" data-action="approve">Approve</button>`}
      <button class="btn btn-reject" data-action="reject">Disapprove</button>
      <button class="btn btn-delete" data-action="delete">Delete</button>
    `;
  }

  if (section === "approved") {
    return `
      <button class="btn btn-reject" data-action="reject">Disapprove</button>
      <button class="btn btn-delete" data-action="delete">Delete</button>
    `;
  }

  if (section === "disapproved") {
    return `
      <button class="btn btn-approve" data-action="approve">Approve</button>
      <button class="btn btn-delete" data-action="delete">Delete</button>
    `;
  }

  if (section === "for_ids_approval") {
    return `
      <button class="btn btn-approve" data-action="approve">Approve</button>
      <button class="btn btn-reject" data-action="reject">Disapprove</button>
      <button class="btn btn-delete" data-action="delete">Delete</button>
    `;
  }

  return "";
}

/* ============================================================
   BUTTON HANDLER
============================================================ */
function handleButtonClick(action, d) {
  if (action === "approve") return updateStatus(d.fileId, "approved");
  if (action === "reject") return updateStatus(d.fileId, "disapproved");
  if (action === "ids")     return updateStatus(d.fileId, "for_ids_approval");
  if (action === "delete")  return deleteEntry(d.fileId);
}

/* ============================================================
   UPDATE STATUS
============================================================ */
async function updateStatus(fileId, status) {
  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "updateStatus",
      fileId: fileId,
      status: status
    })
  });

  await refresh();
}

/* ============================================================
   DELETE ENTRY
============================================================ */
async function deleteEntry(fileId) {
  if (!confirm("Delete this entry?")) return;

  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "deleteEntry",
      fileId: fileId
    })
  });

  await refresh();
}

/* ============================================================
   MODAL VIEWER
============================================================ */
function openModal(d) {
  const modal = document.getElementById("modal");
  const box = document.getElementById("modal-content");

  box.innerHTML = `
    <h3>${d.patientName}</h3>
    <p><strong>Hospital #:</strong> ${d.hospitalnumber}</p>
    <p><strong>Ward:</strong> ${d.ward}</p>
    <p><strong>Date:</strong> ${d.date}</p>

    <hr>

    <p><strong>Drug:</strong> ${d.antimicrobial}</p>
    <p><strong>Dose:</strong> ${d.dose}</p>
    <p><strong>Frequency:</strong> ${d.frequency}</p>
    <p><strong>Duration:</strong> ${d.duration}</p>

    <p><strong>Drug Type:</strong> ${d.drugtype}</p>
    <p><strong>Indication:</strong> ${d.indication}</p>

    <hr>

    <p><strong>Clinical Dept:</strong> ${d.clinicaldept}</p>
    <p><strong>Resident:</strong> ${d.residentName}</p>

    ${d.serviceresidentname
      ? `<p><strong>Service Resident:</strong> ${d.serviceresidentname}</p>`
      : ""}

    ${d.idsspecialist
      ? `<p><strong>IDS Specialist:</strong> ${d.idsspecialist}</p>`
      : ""}

    ${d.disapprovedreason
      ? `<p><strong>Disapproved Reason:</strong> ${d.disapprovedreason}</p>`
      : ""}

    <hr>
    <p><strong>Status:</strong> ${d.status}</p>

    <div style="text-align:right; margin-top:1rem;">
      <button onclick="closeModal()" class="btn">Close</button>
    </div>
  `;

  modal.style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

document.getElementById("modal").onclick = (e) => {
  if (e.target.id === "modal") closeModal();
};

/* ============================================================
   DATA ANALYSIS (Simplified for now)
============================================================ */
function renderAnalysis() {
  const wrap = document.getElementById("analysis");

  const total = ALL_DATA.length;
  const approved = ALL_DATA.filter(d => d.status === "approved").length;
  const rejected = ALL_DATA.filter(d => d.status === "disapproved").length;
  const restricted = ALL_DATA.filter(d => d.drugtype === "Restricted").length;

  wrap.innerHTML = `
    <h3>AMS Summary</h3>
    <p><strong>Total Requests:</strong> ${total}</p>
    <p><strong>Approved:</strong> ${approved}</p>
    <p><strong>Disapproved:</strong> ${rejected}</p>
    <p><strong>Restricted:</strong> ${restricted}</p>
  `;
}

/* ============================================================
   REFRESH + RENDER ALL
============================================================ */
async function refresh() {
  await loadData();
  renderPending();
  renderApproved();
  renderRejected();
  renderIDS();
  renderAnalysis();
}

/* ============================================================
   INIT
============================================================ */
document.getElementById("tab-pending").onclick  = () => { showTab("pending"); renderPending(); };
document.getElementById("tab-approved").onclick = () => { showTab("approved"); renderApproved(); };
document.getElementById("tab-rejected").onclick = () => { showTab("rejected"); renderRejected(); };
document.getElementById("tab-ids").onclick      = () => { showTab("ids"); renderIDS(); };
document.getElementById("tab-analysis").onclick = () => { showTab("analysis"); renderAnalysis(); };

refresh();

</script>
</body>
</html>
